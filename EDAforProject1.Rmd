---
title: 'MSDS 6306: Doing Data Science - Case Study 01'
author: "Hao (Michael) Wang"
date: "10/7/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Get the data
```{r}
Beers <- read.csv(file.choose(), header = TRUE)
Breweries <- read.csv(file.choose(), header = TRUE)
```
# Active library
```{r}
# Visualization
library(tidyverse)
library(plotly)
library(plyr)
library(dplyr)
library(maps)
library(inspectdf)

# data wrangling 
library(stringr)
library(tm)
library(knitr)
library(sqldf)

# classification and modeling
library(class)
library(e1071)
library(caret)
```

# Initial data profiling using package inspectdf
```{r}
# Missing Bar Plots
Nas1 <- inspect_na(Beers)
Nas2 <- inspect_na(Breweries)
show_plot(Nas1, )
show_plot(Nas2, )

#Categorical Plot
Catg1 <- inspect_cat(Beers)
show_plot (Catg1)
Catg2 <- inspect_cat(Breweries)
show_plot (Catg2)
#Correlations
Corl <- inspect_cor(Beers)
show_plot (Corl)

# Distribution of the numeric variables
Numv <- inspect_num(Beers)
show_plot(Numv)

#Feature Imbalance
Imb <- inspect_imb(Beers)
show_plot (Imb)
```

# Preliminary analysis on Beers.csv data
```{r}
str(Beers) # 2410 obs. of 7 variables
summary(Beers)
str(Beers$Name)
summary(Beers$Name)

# Column #1 (Name)
# Check missing value
Beers %>% filter(is.na(Name)) # 0 NA in Name column

# Check unique value
length(unique(Beers$Name)) # 2305
# 105 duplicate names, take a closer look
# First, get the duplicate names and store them as a vector
dup.names <- as.character(Beers[which(duplicated(as.character(Beers$Name))), "Name"])
dup.names
Beers %>% filter(Name == "Hell or High Watermelon Wheat (2009)")  # 2 obs. difference: Beer_ID
Beers %>% filter(Name == "Citra Ass Down")                        # 2 obs. difference: Beer_ID, ABV, Brewery_id, Style
Beers %>% filter(Name == "The Brown Note")                        # 2 obs. difference: Beer_ID, Brewery_id, Style
Beers %>% filter(Name == "Barney Flats Oatmeal Stout")            # 2 obs. difference: Beer_ID
Beers %>% filter(Name == "Angry Orchard Crisp Apple")             # 2 obs. difference: Beer_ID, Ounces
Beers %>% filter(Name == "Oberon")                                # 2 obs. difference: Beer_ID, Ounces
Beers %>% filter(Name == "1327 Pod's ESB")                        # 3 obs. difference: Beer_ID
Beers %>% filter(Name == "Nonstop Hef Hop")                       # 12 obs. difference: Beer_ID
```
```{R}
# Column #2 (Beer_ID)
# Check missing value
Beers %>% filter(is.na(Beer_ID)) # 0 NA
# Check unique value
length(unique(Beers$Beer_ID)) # 2410, no duplicate

# Column #3 (ABV: Alcohol by volume)
# Check missing value
ABV.na <- Beers %>% filter(is.na(ABV)) # 62 NA
ABV.notna <- Beers %>% filter(!is.na(ABV)) # 2346 not NA (Min 0.001, Median 0.056, Mean 0.05977, Max 0.128)
# Check unique value
length(unique(Beers$ABV)) # 75
# Assumption check
## 1. Normality
## 2. Equal variance
## 3. Independence
## 4. Outliers

# Plot 1st
ABV.plotly <- ABV.notna %>% ggplot(aes(x=ABV))+geom_bar()+ggtitle("Beers ABV Distribution")
ggplotly(ABV.plotly)

# Replace NA with median value 0.056
Beers$ABV = str_replace_na(Beers$ABV, replacement =  "0.056")
Beers$ABV = as.numeric(Beers$ABV)

# Re-check missing value
ABV.na <- Beers %>% filter(is.na(ABV)) # 0 NA
ABV.notna <- Beers %>% filter(!is.na(ABV)) # 2410 not NA (Min 0.001, Median 0.056, Mean 0.05968, Max 0.128)

# Plot 2nd
ABV.plotly <- ABV.notna %>% ggplot(aes(x=ABV))+geom_bar()+ggtitle("Beers ABV Distribution")
ggplotly(ABV.plotly)
```

```{R}
# Column #4 (IBU: International Bitterness Units)
# Check missing value
IBU.na <- Beers %>% filter(is.na(IBU)) # 1005 NA
IBU.notna <- Beers %>% filter(!is.na(IBU)) # 1405 not NA
# Check unique value
length(unique(Beers$IBU)) # 75
# Assumption check
## 1. Normality
## 2. Equal variance
## 3. Independence
## 4. Outliers

# Plot 1st
IBU.plotly <- IBU.notna %>% ggplot(aes(x=IBU))+geom_bar()+ggtitle("Beers IBU Distribution")
ggplotly(IBU.plotly)

# NA option1: Replace NA with grand median value 35.00
Beers$IBU = str_replace_na(Beers$IBU, replacement =  "35")
Beers$IBU = as.numeric(Beers$IBU)

# Re-check missing value
IBU.na <- Beers %>% filter(is.na(IBU)) # 0 NA
IBU.notna <- Beers %>% filter(!is.na(IBU)) # 2410 not NA (Min 4.0, Median 35.0, Mean 39.5, Max 138.0)

# Plot 2nd
IBU.plotly <- IBU.notna %>% ggplot(aes(x=IBU))+geom_bar()+ggtitle("Beers IBU Distribution")
ggplotly(IBU.plotly)

# Re-check missing value
IBU.na <- Beers %>% filter(is.na(IBU)) # 0 NA
IBU.notna <- Beers %>% filter(!is.na(IBU)) # 2410 not NA
# Check unique value
length(unique(Beers$IBU)) # 107

# Column #5 (Brewery_id)
# Check missing value
Brewery_id.na <- Beers %>% filter(is.na(Brewery_id)) # 0 NA
Brewery_id.notna <- Beers %>% filter(!is.na(Brewery_id)) # 2410 not NA
# Check unique value
length(unique(Beers$Brewery_id)) # 558
Brewery_id.plotly <- Brewery_id.notna %>% ggplot(aes(x=Brewery_id))+geom_bar()+ggtitle("Brewery_id Distribution")
ggplotly(Brewery_id.plotly)

# Column #6 (Style)
# Check missing value
Style.na <- Beers %>% filter(is.na(Style)) # 0 NA
Style.notna <- Beers %>% filter(!is.na(Style)) # 2410 not NA
# Check unique value
length(unique(Beers$Style)) # 100
Style.plotly <- Style.notna %>% ggplot(aes(x=Style))+geom_bar()+ggtitle("Style Distribution")
ggplotly(Style.plotly)

# Column #7 (Ounces)
# Check missing value
Ounces.na <- Beers %>% filter(is.na(Ounces)) # 0 NA
Ounces.notna <- Beers %>% filter(!is.na(Ounces)) # 2410 not NA
# Check unique value
length(unique(Beers$Ounces)) # 100
Ounces.plotly <- Ounces.notna %>% ggplot(aes(x=Ounces))+geom_bar()+ggtitle("Ounces Distribution")
ggplotly(Ounces.plotly)
```

# Preliminary analysis on Breweries.csv data
```{r}
# Column #1 (Brew_ID)
# Check missing value
Brew_ID.na <- Breweries %>% filter(is.na(Brew_ID)) # 0 NA
Brew_ID.notna <- Breweries %>% filter(!is.na(Brew_ID)) # 558 not NA

# Check unique value
length(unique(Breweries$Brew_ID)) # 558
Brew_ID.plotly <- Brew_ID.notna %>% ggplot(aes(x=Brew_ID))+geom_bar()+ggtitle("Brew_ID Distribution")
ggplotly(Brew_ID.plotly)

# Column #2 (Name)
# Check missing value
Brew_Name.na <- Breweries %>% filter(is.na(Name)) # 0 NA
Brew_Name.notna <- Breweries %>% filter(!is.na(Name)) # 558 not NA

# Check unique value
length(unique(Breweries$Name)) # 551, there are 7 duplicates

# Check duplicates
dup.Brew_Name <- as.character(Breweries[which(duplicated(as.character(Breweries$Name))), "Name"])
Breweries %>% filter(Name == "Blackrocks Brewery")      # 2 obs. difference: Brew_ID, State (MI, MA)
Breweries %>% filter(Name == "Summit Brewing Company")  # 2 obs. difference: Brew_ID, City (St. Paul, St Paul, same city?)
Breweries %>% filter(Name == "Otter Creek Brewing")     # 2 obs. difference: Brew_ID, City (Waterbury, Middlebury)
Breweries %>% filter(Name == "Sly Fox Brewing Company") # 2 obs. difference: Brew_ID, City (Phoenixville, Pottstown)
Breweries %>% filter(Name == "Blue Mountain Brewery")   # 2 obs. difference: Brew_ID, City (Afton, Arrington)
Breweries %>% filter(Name == "Lucette Brewing Company") # 2 obs. difference: Brew_ID, City (Menominee, Menominie, same city?)
Breweries %>% filter(Name == "Oskar Blues Brewery")     # 2 obs. difference: Brew_ID, City (Longmont, Lyons)

# Correct the city names
Breweries$City = str_replace_all(Breweries$City, "St. Paul", "St Paul") ## Change City St. Paul to St Paul
Breweries$City = str_replace_all(Breweries$City, "Menominee", "Menominie") ## Change City Menominee to Menominie

# plot
Brew_Name.plotly <- Brew_Name.notna %>% ggplot(aes(x=Name))+geom_bar()+ggtitle("Brew_Name Distribution")
ggplotly(Brew_Name.plotly)

# Treemap
library(treemap)
Brew_tm1 <- Brew_Name.notna %>% 
  group_by(State) %>% 
  dplyr::summarise(NumBrew=n()) # 2 Obv: State, NumBrew
Brew_tm1$State.NumBrew <- do.call(paste, c(Brew_tm1[c("State","NumBrew")], sep = "\n")) # create 3rd column

treemap(Brew_tm1, # Your data frame object
        index = c("State.NumBrew"),
        vSize = "NumBrew",
        type = "index", # index, value, comp, dens, depth, categorical, color, manual
        palette = "Reds",
        title = "Number of Breweries in States",
        fontsize.title = 14
        )

Brew_tm2 <- Brew_Name.notna %>%
  group_by(City, State) %>%
  dplyr::summarise(NumBrew=n()) # 2 Obv: City, NumBrew
Brew_tm2$City.NumBrew <- do.call(paste, c(Brew_tm2[c("City","NumBrew")], sep = "\n")) # create 3rd column

treemap(Brew_tm2, # Your data frame object
        index = c("City.NumBrew"),
        vSize = "NumBrew",
        type = "index", # index, value, comp, dens, depth, categorical, color, manual
        palette = "Reds",
        title = "Number of Breweries in Cities",
        fontsize.title = 14
        )
```

```{r}
# Column #3 (City)
# Check missing value
City.na <- Breweries %>% filter(is.na(City)) # 0 NA
City.notna <- Breweries %>% filter(!is.na(City)) # 558 not NA
# Check unique value
length(unique(Breweries$City)) # 382, there are 176 duplicates
# plot
City.plotly <- City.notna %>% ggplot(aes(x=City))+geom_bar()+ggtitle("City Distribution")
ggplotly(City.plotly)

# Column #4 (State)
# Check missing value
State.na <- Breweries %>% filter(is.na(State)) # 0 NA
State.notna <- Breweries %>% filter(!is.na(State)) # 558 not NA
# Check unique value
length(unique(Breweries$State)) # 51 states
# plot
State.plotly <- Breweries %>% ggplot(aes(x=State))+geom_bar()+ggtitle("State Distribution")
ggplotly(State.plotly)
```

# 1. How many breweries are present in each state?
```{r}
# Count breweries in each state
Breweries.order <- Breweries %>%
  group_by(State) %>%
  dplyr::summarize(count=n())
Breweries.order

# Plot
Breweries.order$State = factor(Breweries.order$State, level = Breweries.order$State[order(Breweries.order$count)]) 
Breweries.order %>% 
  ggplot(aes(x=State, y=count, fill=State))+geom_bar(stat = "identity", width = 0.8) +
  ylab("Breweries Count")+ggtitle("Breweries v. State")+
  geom_text(aes(label=count), hjust=-0.5) +
  theme(axis.text.y = element_text(size = 6)) +
  coord_flip()
ggplotly()
```
# 2. Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.  (RMD only, this does not need to be included in the presentation or the deck.)
```{r}
Beer.merge <- merge(Beers, Breweries, by.x = "Brewery_id", by.y = "Brew_ID")
colnames(Beer.merge)[2] = "Beer_name"
colnames(Beer.merge)[8] = "Brewery_name"
# Beer.merge$Name.x = Beer.merge$Beer_Name
# Beer.merge$Name.y = Beer.merge$Brew_Name
```
# 3.   Address the missing values in each column.
```{r}
# NA option2: Replace NA in IBU column with state median.
# create a new column IBU_median_state,
test <- Beers %>% group_by(State) %>% dplyr::summarise(median = median(IBU))
```
# 4. Compute the median alcohol content(ABV) and international bitterness unit (IBU) for each state. Plot a bar chart to compare.
```{r}
NumState <- length(levels(Beer.merge$State))
StateChar <- levels(Beer.merge$State)
State <- c()
ABVmedian <- c()
IBUmedian <- c()

for (i in 1:NumState) {
  df <- Beer.merge %>% filter(State == StateChar[i])
  State = c(State, StateChar[i])
  ABVmedian = c(ABVmedian, median(df$ABV))
  IBUmedian = c(IBUmedian, median(df$IBU))
}
DfMedian <- data.frame(State=State, ABVmedian=ABVmedian, IBUmedian=IBUmedian)

# plot
DfMedian$State <- factor(DfMedian$State, level = DfMedian$State[order(DfMedian$ABVmedian)])

## View DfMedian see 'NA'

DfMedian %>% ggplot(aes(x=State, y=ABVmedian, fill=State)) + geom_bar(stat = "identity") + ggtitle("ABV Median in States")+
  geom_text(aes(label=ABVmedian), hjust=-0.5) +
  theme(axis.text.y = element_text(size = 6)) +
  coord_flip()
ggplotly()

DfMedian$State <- factor(DfMedian$State, level = DfMedian$State[order(DfMedian$IBUmedian)])
DfMedian %>% ggplot(aes(x=State, y=IBUmedian, fill=State)) + geom_bar(stat = "identity") + ggtitle("IBU Median in States")+
  geom_text(aes(label=IBUmedian), hjust=-0.5) +
  theme(axis.text.y = element_text(size = 6)) +
  coord_flip()
ggplotly()
```
# 5. Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
```{r}
NumState <- length(levels(Beer.merge$State))
StateChar <- levels(Beer.merge$State)
State <- c()
ABVmax <- c()
IBUmax <- c()

for (i in 1:NumState) {
  df <- Beer.merge %>% filter(State == StateChar[i])
  State = c(State, StateChar[i])
  ABVmax = c(ABVmax, max(df$ABV))
  IBUmax = c(IBUmax, max(df$IBU))
}
DfMax <- data.frame(State=State, ABVmax=ABVmax, IBUmax=IBUmax)

# plot
DfMax$State <- factor(DfMax$State, level = DfMax$State[order(-DfMax$ABVmax)])
DfMax %>% ggplot(aes(x=State, y=ABVmax, fill=State)) + geom_bar(stat = "identity") + ggtitle("Maximum ABV in States")+
  geom_text(aes(label=ABVmax), hjust=-0.5) +
  theme(axis.text.y = element_text(size = 6)) +
  coord_flip()
ggplotly()

DfMax$State <- factor(DfMax$State, level = DfMax$State[order(-DfMax$IBUmax)])
DfMax %>% ggplot(aes(x=State, y=IBUmax, fill=State)) + geom_bar(stat = "identity") + ggtitle("Maximum IBU in States")+
  geom_text(aes(label=IBUmax), hjust=-0.5) +
  theme(axis.text.y = element_text(size = 6)) +
  coord_flip()
ggplotly()
```
# 6. Comment on the summary statistics and distribution of the ABV variable.
```{r}
Beer.merge %>% ggplot(aes(y=ABV)) + geom_boxplot()
Beer.merge %>% ggplot(aes(x=ABV)) + geom_histogram(fill="blue", color="black")
```
# 7. Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.
```{r}
Beer.merge %>% ggplot(aes(x=IBU, y=ABV)) + geom_point(aes(color=State), size=1, position="jitter") + geom_smooth()
ggplotly()
```
# 8. Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN clustering to investigate this relationship.  Provide statistical evidence one way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy to understand.
```{r}
Beer.merge$IPA_Ale <- ifelse(str_detect(Beer.merge$Style,"IPA"),"IPA",ifelse(str_detect(Beer.merge$Style,"Ale"),"Ale","Other"))
Beer.merge.knn <- Beer.merge %>% filter(IPA_Ale == "IPA" | IPA_Ale == "Ale")

## 

splitPerc = .75
iterations = 50
numks = 30

masterAcc = matrix(nrow = iterations, ncol = numks)
  
for(j in 1:iterations)
{
  accs = data.frame(accuracy = numeric(30), k = numeric(30))
  trainIndices = sample(1:dim(Beer.merge.knn)[1],round(splitPerc * dim(Beer.merge.knn)[1]))
  train = Beer.merge.knn[trainIndices,]
  test = Beer.merge.knn[-trainIndices,]
  for(i in 1:numks)
    {
    classifications = knn(train[,c(4,5)],test[,c(4,5)],train$IPA_Ale, prob = TRUE, k = i)
    table(classifications,test$IPA_Ale)
    CM = confusionMatrix(table(classifications,test$IPA_Ale))
    masterAcc[j,i] = CM$overall[1]
  }
}

MeanAcc = colMeans(masterAcc)
maxMeanAcc = max(MeanAcc) # k=?
plot(seq(1,numks,1),MeanAcc, type = "l")

classifications5 = knn(train[,c(4,5)],test[,c(4,5)],train$IPA_Ale, prob = TRUE, k = 5)
table(classifications5,test$IPA_Ale)
CM5 = confusionMatrix(table(classifications5,test$IPA_Ale))

```

```{r}
splitPerc = .80
iterations = 50
numks = 30

masterAcc = matrix(nrow = iterations, ncol = numks)
  
for(j in 1:iterations)
{
  accs = data.frame(accuracy = numeric(30), k = numeric(30))
  trainIndices = sample(1:dim(Beer.merge.knn)[1],round(splitPerc * dim(Beer.merge.knn)[1]))
  train = Beer.merge.knn[trainIndices,]
  test = Beer.merge.knn[-trainIndices,]
  for(i in 1:numks)
    {
    classifications = knn(train[,c(4,5)],test[,c(4,5)],train$IPA_Ale, prob = TRUE, k = i)
    table(classifications,test$IPA_Ale)
    CM = confusionMatrix(table(classifications,test$IPA_Ale))
    masterAcc[j,i] = CM$overall[1]
  }
}

MeanAcc = colMeans(masterAcc)
maxMeanAcc = max(MeanAcc) # k=?
plot(seq(1,numks,1),MeanAcc, type = "l")

classifications5 = knn(train[,c(4,5)],test[,c(4,5)],train$IPA_Ale, prob = TRUE, k = 5)
table(classifications5,test$IPA_Ale)
CM5 = confusionMatrix(table(classifications5,test$IPA_Ale))
```


# 9. Knock their socks off!  Find one other useful inference from the data that you feel Budweiser may be able to find value in.  You must convince them why it is important and back up your conviction with appropriate statistical evidence.
```{r}
# Heatmap
```

